<!DOCTYPE html>
<html>

<head>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/ag-grid/dist/ag-grid.min.noStyle.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.8.6/showdown.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/ag-grid/dist/styles/ag-grid.css">
  <link rel="stylesheet" href="https://unpkg.com/ag-grid/dist/styles/ag-theme-material.css">
  <link rel="stylesheet" href="prism.css">
</head>

<body>
  <script src="prism.js"></script>
  <style>
    h1{
      font: 600 42px "Roboto", sans-serif;
    }
    p{
      font: 400 14px "Roboto", sans-serif;
    }
    .ag-theme-material .bg-success {
      background-color: lightgreen !important;
    }
    .ag-theme-material .bg-fail {
      background-color: lightcoral !important;
    }
    .ag-theme-material .bg-todo {
      background-color: lightblue !important;
    }
    .ag-theme-material .bg-wontdo {
      background-color: lightslategray !important;
    }
    .modal {
      max-width: 800px;
      background-color: #2d2d2d;
    }
    .jquery-modal{
      background-color: rgba(0,0,0,0.4);
    }
  </style>
  
  <h1>TESTS REPORT : <span id="language"></span></h1>
  <p>
    <span id="number"></span> tests launched at <span id="datetime"></span>
  </p>
  
  <canvas id="pie-chart" width="250" height="250"></canvas>
  <br>
  <div id="myGrid" style="width:auto;" class="ag-theme-material"></div>
  <div id="ex1" class="modal">
    
    <a href="#" rel="modal:close">Close</a>
  </div>
  <script type="text/javascript" charset="utf-8">
    function setLanguage(language) {
      var languageContainer = document.getElementById("language");
      languageContainer.innerHTML = language
    }
    
    function setDatetime(datetime) {
      var datetimeContainer = document.getElementById("datetime");
      datetimeContainer.innerHTML = datetime;
    }
    
    function setNumber(dataArr) {
      var numberContainer = document.getElementById("number");
      numberContainer.innerHTML = dataArr.length;
    }
    
    function getTestCounts(dataArray) {
      var 
        fail = 0,
        success = 0,
        todo = 0,
        wontdo = 0;
        
      dataArray.forEach(el => {
        switch (el.status) {
          case 'Success':
            ++success;
            break;
          case 'Fail':
            ++fail;
            break;
          case 'Todo':
            ++todo;
            break;
          default:
            ++wontdo;
        } 
      });
        
      return {
        total: dataArray.length,
        fail: fail,
        todo: todo,
        success: success,
        wontdo: wontdo
      };
    }
    
    function getData(url, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.onload = function (e) {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            var res = xhr.responseText;
            try {
              callback(JSON.parse(res));
            }
            catch (e) {
              callback(res);
            }
          } else {
            console.error(xhr.statusText);
          }
        }
      };

      xhr.onerror = function (e) {
        console.error(xhr.statusText);
      };
      xhr.send(null);
    }
    
    getData('report.json', function (report) {
      var dataArr = Object.values(report)

      var columnDefs = [
        { headerName: "NAME", field: "name" },
        { headerName: "DESCRIPTION", field: "description" },
        { headerName: "STATUS", field: "status" },
        { headerName: "EXPECTED", field: "expected" },
        { headerName: "GOT", field: "got" },
        { headerName: "FILE", field: "file", cellRenderer: function(params){return '<a class="file-Link" href="' + params.value.split('/').pop() +'">' + params.value + '</a>'} }
      ];

      var rowData = [];
      dataArr.forEach(function (el) {
        rowData.push({
          name: el.test.name,
          description: el.test.description,
          status: el.status,
          expected: el.test.expect,
          got: (Object.keys(el.error).length !== 0) ? el.error.code + ' : ' + el.error.got : el.test.expect,
          file: el.file
        })
      });

      var gridOptions = {
        columnDefs: columnDefs,
        rowData: rowData,
        enableSorting: true,
        gridAutoHeight: true,
        rowClassRules: {
          'bg-success': function (params) {
            if (params.data.status == 'Success') {
              return true;
            }
            return false;
          },
          'bg-fail': function (params) {
            if (params.data.status == 'Fail') {
              return true;
            }
            return false;
          },
          'bg-todo': function (params) {
            if (params.data.status == 'Todo') {
              return true;
            }
            return false;
          },
          'bg-wontdo': function (params) {
            if (params.data.status == 'Wontdo') {
              return true;
            }
            return false;
          },
        }
      };

      var eGridDiv = document.querySelector('#myGrid');
      var grid = new agGrid.Grid(eGridDiv, gridOptions);
      var allColumnIds = [];
      gridOptions.columnApi.getAllColumns().forEach(function (column) {
        allColumnIds.push(column.colId);
      });
      gridOptions.columnApi.autoSizeColumns(allColumnIds);
      
      // CHARTS
      var testCount = getTestCounts(dataArr);
      var ctx = document.getElementById("pie-chart").getContext("2d");
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ["Success", "Fail", 'Todo', 'Wontdo'],
          datasets: [{
            label: "Tests status",
            backgroundColor: ["#90EE90", "#F08080", "#ADD8E6", "#778899"],
            data: [testCount.success, testCount.fail, testCount.todo, testCount.wontdo]
          }]
        },
        options: {
          responsive: false
        }
      });
      
      setLanguage(dataArr[0].language);
      setDatetime(dataArr[0].datetime);
      setNumber(dataArr);
      
    });
    
    // SEE FILE MARKDOWN
    $(document).on('click', 'a', function (e) {
      e.preventDefault();
      var file = $(this).attr('href');
      getData('failed/' + file, function(fileContent){
        var 
          converter = new showdown.Converter(),
          html = converter.makeHtml('```' + file.split('.')[1] +'\n' + fileContent + '\n```');
          
        $('.modal').html(html)
        $('.modal').modal()
        $('.modal pre').addClass('line-numbers')
        Prism.highlightAll();
      })  
    })
    
  </script>
</body>

</html>