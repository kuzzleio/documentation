version: 0.2

phases:
  install:
    commands:
      - docker pull kuzzleio/documentation-v2:go
      - sysctl -w vm.max_map_count=262144
      - bash .codepipeline/start_kuzzle.sh
  build:
    commands:
      - docker run -a stdout -a stderr --rm --privileged --network codepipeline_default --link kuzzle -v "$(pwd)":/app -v "$(pwd)"/test/bin:/go/src/github.com/kuzzleio/go-test kuzzleio/documentation-v2:go
  post_build:
    commands:
      - aws s3 sync reports/ s3://$AWS_S3_BUCKET/reports/go/release/
      - aws cloudfront create-invalidation --distribution-id $AWS_CLOUDFRONT_DISTRIBUTION_ID --paths "/*"
